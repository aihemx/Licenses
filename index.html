<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ======================== CSS VARIABLES ======================== */
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --bg-card-hover: #1f2b47;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --text-muted: #6b7280;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --border-color: rgba(99, 102, 241, 0.2);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.3);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        /* ======================== RESET & BASE ======================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* ======================== LAYOUT ======================== */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ======================== HEADER ======================== */
        .app-header {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px 30px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-gradient);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--accent-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-secondary);
            padding: 10px 16px;
            border-radius: var(--radius-md);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-name {
            font-weight: 500;
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* ======================== NAVIGATION ======================== */
        .nav-tabs {
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .nav-tab {
            padding: 12px 24px;
            border-radius: var(--radius-md);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent-gradient);
            color: white;
        }

        /* ======================== DASHBOARD ======================== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            background: var(--bg-card-hover);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .stat-icon.active {
            background: rgba(16, 185, 129, 0.2);
        }

        .stat-icon.expired {
            background: rgba(239, 68, 68, 0.2);
        }

        .stat-icon.pending {
            background: rgba(245, 158, 11, 0.2);
        }

        .stat-icon.suspended {
            background: rgba(156, 163, 175, 0.2);
        }

        .stat-icon.total {
            background: rgba(99, 102, 241, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-value.active {
            color: var(--success);
        }

        .stat-value.expired {
            color: var(--danger);
        }

        .stat-value.pending {
            color: var(--warning);
        }

        .stat-value.suspended {
            color: var(--text-muted);
        }

        .stat-value.total {
            color: var(--accent-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Alert Card */
        .alert-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 24px;
        }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-title {
            font-weight: 600;
            color: var(--warning);
        }

        .alert-list {
            list-style: none;
        }

        .alert-list li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-list li:last-child {
            border-bottom: none;
        }

        /* ======================== TABLE ======================== */
        .table-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 10px 16px 10px 40px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            width: 250px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-box::before {
            content: "ğŸ”";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .filter-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 10px 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            border: none;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 16px 20px;
            text-align: right;
        }

        .data-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: var(--bg-card-hover);
        }

        .data-table tbody tr.expiring-soon {
            background: rgba(245, 158, 11, 0.05);
        }

        .data-table tbody tr.expiring-soon:hover {
            background: rgba(245, 158, 11, 0.1);
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .status-badge.expired {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .status-badge.suspended {
            background: rgba(156, 163, 175, 0.15);
            color: var(--text-muted);
        }

        .status-badge.inactive {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-muted);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* ======================== MODAL ======================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-start;
            gap: 12px;
        }

        /* ======================== FORM ======================== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-control:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-error {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 6px;
        }

        /* ======================== LOADING ======================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 26, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 16px;
            color: var(--text-secondary);
        }

        /* ======================== TOAST ======================== */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
            border-right: 4px solid;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast.warning {
            border-color: var(--warning);
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
        }

        /* ======================== EMPTY STATE ======================== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.25rem;
            margin-bottom: 8px;
        }

        .empty-text {
            color: var(--text-secondary);
        }

        /* ======================== RESPONSIVE ======================== */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .nav-tabs {
                overflow-x: auto;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .table-actions {
                flex-direction: column;
            }

            .search-box input {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Main App -->
    <div class="app-container" id="app" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="app-logo">
                <div class="app-logo-icon">ğŸ“‹</div>
                <h1 class="app-title">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ</h1>
            </div>
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">Ù…</div>
                <div>
                    <div class="user-name" id="userName">Ù…Ø³ØªØ®Ø¯Ù…</div>
                    <div class="user-role" id="userRole">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-view="dashboard">
                <span>ğŸ“Š</span> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </button>
            <button class="nav-tab" data-view="licenses">
                <span>ğŸ“„</span> Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ
            </button>
        </nav>

        <!-- Dashboard View -->
        <section id="dashboardView">
            <!-- Stats Grid -->
            <div class="dashboard-grid" id="statsGrid">
                <!-- Stats will be loaded here -->
            </div>

            <!-- Expiring Soon Alert -->
            <div class="alert-card" id="expiringAlert" style="display: none;">
                <div class="alert-header">
                    <span class="alert-icon">âš ï¸</span>
                    <span class="alert-title">ØªØ±Ø§Ø®ÙŠØµ ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù…</span>
                </div>
                <ul class="alert-list" id="expiringList">
                    <!-- Expiring licenses will be loaded here -->
                </ul>
            </div>
        </section>

        <!-- Licenses View -->
        <section id="licensesView" style="display: none;">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ</h2>
                    <div class="table-actions">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…...">
                        </div>
                        <select class="filter-select" id="statusFilter">
                            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="Active">Ù†Ø´Ø·</option>
                            <option value="Pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                            <option value="Expired">Ù…Ù†ØªÙ‡ÙŠ</option>
                            <option value="Suspended">Ù…Ø¹Ù„Ù‚</option>
                            <option value="Inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
                        </select>
                        <button class="btn btn-primary" id="addLicenseBtn" style="display: none;">
                            <span>â•</span> Ø¥Ø¶Ø§ÙØ© ØªØ±Ø®ÙŠØµ
                        </button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                            <th>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="licensesTableBody">
                        <!-- Licenses will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- License Form Modal -->
    <div class="modal-overlay" id="licenseModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© ØªØ±Ø®ÙŠØµ Ø¬Ø¯ÙŠØ¯</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="licenseForm">
                    <input type="hidden" id="licenseId">

                    <div class="form-group">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
                        <input type="text" class="form-control" id="clientName" required minlength="3">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ *</label>
                        <input type="tel" class="form-control" id="whatsapp" required placeholder="+218912345678">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ *</label>
                        <select class="form-control" id="subscriptionType" required>
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© *</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </div>

                    <div class="form-group" id="statusGroup" style="display: none;">
                        <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø© (ØªØºÙŠÙŠØ± ÙŠØ¯ÙˆÙŠ)</label>
                        <select class="form-control" id="statusSelect">
                            <option value="">Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
                            <option value="Suspended">Ù…Ø¹Ù„Ù‚</option>
                            <option value="Inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea class="form-control" id="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="font-size: 48px; margin-bottom: 16px;">ğŸ—‘ï¸</p>
                <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ±Ø®ÙŠØµØŸ</p>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Ù„Ù† ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ Ø³ÙŠØªÙ… ØªØ¹Ù„ÙŠÙ…Ù‡ ÙƒÙ…Ø­Ø°ÙˆÙ.</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-danger" id="confirmDeleteBtn">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // ======================== GLOBAL STATE ========================
        let currentUser = null;
        let allLicenses = [];
        let subscriptionTypes = [];
        let deleteTargetId = null;

        // ======================== INITIALIZATION ========================
        document.addEventListener('DOMContentLoaded', function () {
            initApp();
        });

        async function initApp() {
            try {
                // Load user info
                const userResult = await callServer('getCurrentUserInfo');
                if (!userResult.success) {
                    showToast(userResult.message, 'error');
                    return;
                }
                currentUser = userResult.data;
                updateUserUI();

                // Load lists
                const listsResult = await callServer('getAllLists');
                if (listsResult.success) {
                    subscriptionTypes = listsResult.data.subscriptionTypes;
                    populateSubscriptionDropdown();
                }

                // Load dashboard
                await loadDashboard();

                // Load licenses
                await loadLicenses();

                // Setup event listeners
                setupEventListeners();

                // Hide loading, show app
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('app').style.display = 'block';

            } catch (error) {
                console.error('Init Error:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…', 'error');
            }
        }

        // ======================== SERVER CALLS ========================
        function callServer(functionName, ...args) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                [functionName](...args);
            });
        }

        // ======================== USER UI ========================
        function updateUserUI() {
            document.getElementById('userName').textContent = currentUser.fullName || currentUser.email;
            document.getElementById('userRole').textContent = translateRole(currentUser.role);
            document.getElementById('userAvatar').textContent = (currentUser.fullName || currentUser.email).charAt(0);

            // Show/hide buttons based on permissions
            if (currentUser.permissions.includes('create')) {
                document.getElementById('addLicenseBtn').style.display = 'inline-flex';
            }
        }

        function translateRole(role) {
            const roles = {
                'Admin': 'Ù…Ø¯ÙŠØ±',
                'Manager': 'Ù…Ø´Ø±Ù',
                'Agent': 'Ù…ÙˆØ¸Ù',
                'Viewer': 'Ù…Ø´Ø§Ù‡Ø¯'
            };
            return roles[role] || role;
        }

        // ======================== NAVIGATION ========================
        function setupEventListeners() {
            // Nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    const view = this.dataset.view;
                    document.getElementById('dashboardView').style.display = view === 'dashboard' ? 'block' : 'none';
                    document.getElementById('licensesView').style.display = view === 'licenses' ? 'block' : 'none';
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', debounce(filterLicenses, 300));

            // Status filter
            document.getElementById('statusFilter').addEventListener('change', filterLicenses);

            // Add license
            document.getElementById('addLicenseBtn').addEventListener('click', openAddModal);

            // Save button
            document.getElementById('saveBtn').addEventListener('click', saveLicense);

            // Confirm delete
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
        }

        // ======================== DASHBOARD ========================
        async function loadDashboard() {
            try {
                const result = await callServer('getDashboardStats');
                if (!result.success) {
                    showToast(result.message, 'error');
                    return;
                }

                const stats = result.data;

                document.getElementById('statsGrid').innerHTML = `
          <div class="stat-card" onclick="filterByStatus('')">
            <div class="stat-icon total">ğŸ“Š</div>
            <div class="stat-value total">${stats.total}</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ</div>
          </div>
          <div class="stat-card" onclick="filterByStatus('Active')">
            <div class="stat-icon active">âœ…</div>
            <div class="stat-value active">${stats.active}</div>
            <div class="stat-label">Ù†Ø´Ø·</div>
          </div>
          <div class="stat-card" onclick="filterByStatus('Expired')">
            <div class="stat-icon expired">âŒ</div>
            <div class="stat-value expired">${stats.expired}</div>
            <div class="stat-label">Ù…Ù†ØªÙ‡ÙŠ</div>
          </div>
          <div class="stat-card" onclick="filterByStatus('Pending')">
            <div class="stat-icon pending">â³</div>
            <div class="stat-value pending">${stats.pending}</div>
            <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
          </div>
          <div class="stat-card" onclick="filterByStatus('Suspended')">
            <div class="stat-icon suspended">â¸ï¸</div>
            <div class="stat-value suspended">${stats.suspended}</div>
            <div class="stat-label">Ù…Ø¹Ù„Ù‚</div>
          </div>
        `;

                // Expiring soon alert
                if (stats.expiringIn7Days > 0) {
                    document.getElementById('expiringAlert').style.display = 'block';
                    document.getElementById('expiringList').innerHTML = stats.expiringLicenses.map(lic => `
            <li>
              <span>${lic.clientName}</span>
              <span style="color: var(--warning);">${lic.remaining} Ø£ÙŠØ§Ù… Ù…ØªØ¨Ù‚ÙŠØ©</span>
            </li>
          `).join('');
                } else {
                    document.getElementById('expiringAlert').style.display = 'none';
                }

            } catch (error) {
                console.error('loadDashboard Error:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'error');
            }
        }

        // ======================== LICENSES TABLE ========================
        async function loadLicenses() {
            try {
                const result = await callServer('getAllLicenses');
                if (!result.success) {
                    showToast(result.message, 'error');
                    return;
                }

                allLicenses = result.data;
                renderLicenses(allLicenses);

            } catch (error) {
                console.error('loadLicenses Error:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ', 'error');
            }
        }

        function renderLicenses(licenses) {
            const tbody = document.getElementById('licensesTableBody');

            if (licenses.length === 0) {
                tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-icon">ğŸ“­</div>
                <div class="empty-title">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ±Ø§Ø®ÙŠØµ</div>
                <div class="empty-text">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ ØªØ±Ø§Ø®ÙŠØµ</div>
              </div>
            </td>
          </tr>
        `;
                return;
            }

            // Sort by end date (closest first)
            licenses.sort((a, b) => new Date(a.endDate) - new Date(b.endDate));

            tbody.innerHTML = licenses.map(lic => {
                const isExpiringSoon = lic.status === 'Active' && lic.remaining <= 7;
                const rowClass = isExpiringSoon ? 'expiring-soon' : '';

                return `
          <tr class="${rowClass}">
            <td><strong>${lic.clientName}</strong></td>
            <td dir="ltr">${lic.whatsapp}</td>
            <td>${lic.subscriptionType}</td>
            <td><span class="status-badge ${lic.status.toLowerCase()}">${translateStatus(lic.status)}</span></td>
            <td>${formatDateDisplay(lic.startDate)}</td>
            <td>${formatDateDisplay(lic.endDate)}</td>
            <td>${lic.remaining} ÙŠÙˆÙ…</td>
            <td>
              <div class="action-buttons">
                ${currentUser.permissions.includes('edit') ? `<button class="btn btn-secondary btn-sm" onclick="editLicense('${lic.id}')">âœï¸</button>` : ''}
                ${currentUser.permissions.includes('delete') ? `<button class="btn btn-danger btn-sm" onclick="deleteLicense('${lic.id}')">ğŸ—‘ï¸</button>` : ''}
              </div>
            </td>
          </tr>
        `;
            }).join('');
        }

        function filterLicenses() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;

            let filtered = allLicenses;

            if (search) {
                filtered = filtered.filter(lic =>
                    lic.clientName.toLowerCase().includes(search) ||
                    lic.whatsapp.includes(search)
                );
            }

            if (status) {
                filtered = filtered.filter(lic => lic.status === status);
            }

            renderLicenses(filtered);
        }

        function filterByStatus(status) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-view="licenses"]').classList.add('active');
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('licensesView').style.display = 'block';

            document.getElementById('statusFilter').value = status;
            filterLicenses();
        }

        // ======================== MODAL OPERATIONS ========================
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© ØªØ±Ø®ÙŠØµ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('licenseForm').reset();
            document.getElementById('licenseId').value = '';
            document.getElementById('statusGroup').style.display = 'none';

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;

            document.getElementById('licenseModal').classList.add('active');
        }

        function editLicense(id) {
            const license = allLicenses.find(l => l.id === id);
            if (!license) return;

            document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ±Ø®ÙŠØµ';
            document.getElementById('licenseId').value = license.id;
            document.getElementById('clientName').value = license.clientName;
            document.getElementById('whatsapp').value = license.whatsapp;
            document.getElementById('subscriptionType').value = license.subscriptionType;
            document.getElementById('startDate').value = license.startDate;
            document.getElementById('endDate').value = license.endDate;
            document.getElementById('notes').value = license.notes || '';

            // Show status for Admin/Manager
            if (currentUser.permissions.includes('change_status')) {
                document.getElementById('statusGroup').style.display = 'block';
                document.getElementById('statusSelect').value =
                    ['Suspended', 'Inactive'].includes(license.status) ? license.status : '';
            } else {
                document.getElementById('statusGroup').style.display = 'none';
            }

            document.getElementById('licenseModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('licenseModal').classList.remove('active');
        }

        function deleteLicense(id) {
            deleteTargetId = id;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            deleteTargetId = null;
            document.getElementById('deleteModal').classList.remove('active');
        }

        // ======================== SAVE LICENSE ========================
        async function saveLicense() {
            const id = document.getElementById('licenseId').value;
            const data = {
                clientName: document.getElementById('clientName').value,
                whatsapp: document.getElementById('whatsapp').value,
                subscriptionType: document.getElementById('subscriptionType').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                notes: document.getElementById('notes').value,
                status: document.getElementById('statusSelect').value || null
            };

            // Basic validation
            if (!data.clientName || data.clientName.length < 3) {
                showToast('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }

            if (!data.whatsapp) {
                showToast('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø·Ù„ÙˆØ¨', 'error');
                return;
            }

            if (!data.subscriptionType) {
                showToast('Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø·Ù„ÙˆØ¨', 'error');
                return;
            }

            if (!data.startDate || !data.endDate) {
                showToast('Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                return;
            }

            if (new Date(data.startDate) >= new Date(data.endDate)) {
                showToast('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', 'error');
                return;
            }

            try {
                showLoading(true);

                let result;
                if (id) {
                    result = await callServer('updateLicense', id, data);
                } else {
                    result = await callServer('createLicense', data);
                }

                showLoading(false);

                if (result.success) {
                    showToast(result.message, 'success');
                    closeModal();
                    await loadLicenses();
                    await loadDashboard();
                } else {
                    showToast(result.message, 'error');
                }

            } catch (error) {
                showLoading(false);
                console.error('saveLicense Error:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸', 'error');
            }
        }

        // ======================== DELETE LICENSE ========================
        async function confirmDelete() {
            if (!deleteTargetId) return;

            try {
                showLoading(true);

                const result = await callServer('deleteLicense', deleteTargetId);

                showLoading(false);
                closeDeleteModal();

                if (result.success) {
                    showToast(result.message, 'success');
                    await loadLicenses();
                    await loadDashboard();
                } else {
                    showToast(result.message, 'error');
                }

            } catch (error) {
                showLoading(false);
                console.error('confirmDelete Error:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
            }
        }

        // ======================== HELPERS ========================
        function populateSubscriptionDropdown() {
            const select = document.getElementById('subscriptionType');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</option>';
            subscriptionTypes.forEach(type => {
                select.innerHTML += `<option value="${type}">${type}</option>`;
            });
        }

        function translateStatus(status) {
            const statuses = {
                'Active': 'Ù†Ø´Ø·',
                'Expired': 'Ù…Ù†ØªÙ‡ÙŠ',
                'Pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                'Suspended': 'Ù…Ø¹Ù„Ù‚',
                'Inactive': 'ØºÙŠØ± Ù†Ø´Ø·'
            };
            return statuses[status] || status;
        }

        function formatDateDisplay(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ar-LY', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
      `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function debounce(fn, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }
    </script>
</body>

</html>